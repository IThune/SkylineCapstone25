# OPNsense Overview #

OPNsense is an all-in-one network security appliance. In the Skyline network, it acts as a router and a firewall, and comes with Wireguard as a VPN solution and Suricata for network intrusion detection (NIDS).

## Skyline Network Gateway ##

We deploy OPNsense as a virtual machine in Azure to allow routing between our cloud-hosted NVR and on-site IP security cameras. It also allows authorized users to access the NVR for playback of footage, and IT admins the ability to remotely manage the network.

The VM deployed in this project is a B2ms-size Azure virtual machine in a 2-nic configuration.

## Wireguard VPN ##

To securely connect cameras to the NVR system, allow users to access the NVR web interface, and allow IT administrators remote access to manage resources, we tunnel their connections over a secure VPN connection called Wireguard.

### Why Wireguard? ###

1.  Easy to configure

    Wireguard is easier to configure than competitors such as OpenVPN or IPsec. Config files for clients are easy to write and
    manage, and can even be generated by OPNsense's Wireguard plugin.

2.  High Performance

    Because Wireguard runs over UDP, there is very little overhead in the protocol. For this reason it is ideal for a bandwidth-
    sensitive application like our use case.

3.  Secure

    The Wireguard protocol has been peer-reviewed to be as cryptographically secure as possible. It uses the latest in encryption
    technology.

## Access Control with Wireguard and OPNsense Firewall ##

While technically a peer-to-peer protocol, Wireguard can be configured to resemble a client-server model, where a central server
makes routing decisions for each client on the network. In Wireguard, each member of the network is called a 'peer' so I will be
calling clients peers. 

So, how do we manage access to resources for each peer? We *could* use Wireguard's AllowedIPs config option, but it is a limitation because Wireguard runs over UDP and by nature is connection-less, so we cannot apply traffic rules based on the tunneled protocol. Also, managing each peer configuration would be more difficult when we can just use the capabilities of OPNsense for this.

To manage access rights for each peer, they are separated into peer groups. We assign each client an IP address within a specified subnet of the Wireguard network (The entire Wireguard network is 10.10.0.0/16), create an 'alias' for each peer group's subnet within OPNsense, and tag traffic based on its IP to apply firewall rules to that peer group.

First, there are 3 different peer groups in our environment, each with its own subnet in the 10.10.0.0/16 range:

| Peer Group | Description | Subnet |
| --------- | ----------- | --------------- |
| CCTV Cameras | Members are CCTV cameras that are sending footage to the NVR. | 10.10.255.0/24 |
| NVR Users | These members are users of the NVR system. They are able to log in to the NVR's web interface | 10.10.0.0/24 |
| IT Admins | Members of this group are allowed to manage IT resources for Skyline. | 10.10.100.0/24 |

We need to control access to different IP addresses in our environment. The IP addresses in our environment are:

| IP Address | Description |
| ---------- | ----------- |
| 10.0.0.4   | The "LAN" Interface of the OPNsense virtual machine |
| 10.0.0.5   | The Zoneminder NVR host |
| 10.10.0.0/16 | Hosts on the Wireguard network |

Now that peers have been assigned to a group in OPNsense, we just need to make sure they are assigned in IP in the correct subnet and our traffic rules will be applied. It would look like this:

| Peer Name | Peer Group | Peer IP | Allowed IPs & Ports |
| --------- | ---------- | ------- | ------------------- |
| CCTV Cam 1 | CCTV Cameras | 10.10.255.1 | 10.0.0.5/32 IANA high ports udp |
| CCTV Cam 2 | CCTV Cameras | 10.10.255.2 | 10.0.0.5/32 IANA high ports udp |
| CCTV cam x | CCTV Cameras | 10.10.255.x | 10.0.0.5/32 IANA high ports udp |
| NVR user 1 | NVR Users | 10.10.0.1 | 10.0.0.5/32 http/https |
| NVR user 2 | NVR Users | 10.10.0.1 | 10.0.0.5/32 http/https |
| NVR user x | NVR Users | 10.10.0.x | 10.0.0.5/32 http/https |
| IT admin 1 | IT Admins | 10.10.100.1 | 10.0.0.0/24 10.10.0.0/16 any |
| IT admin 2 | IT Admins | 10.10.100.2 | 10.0.0.0/24 10.10.0.0/16 any |


## Network Intrusion Detection ##

An IDS or an Intrusion detection system monitors any outbound connections from your network, so if a device is trying to connect to somewhere it shouldnâ€™t the IDS will block the connection. How the IDS operates is through rulesets and these rulesets are provided through a company called Proofpoint, they are an IT cybersecurity company and offer an updating ruleset. Each rule within a ruleset are different types of attacks and within the rules there are IPs of known threat actors that are associated with these types of attacks. Another thing that Proofpoint does with their ruleset is constantly updating it with new threat actors for attacks, so it is a constantly evolving defensive mechanism. To apply these changes to the ruleset every week, month, or year we can schedule an automatic update to happen to the ruleset and what time it will happen, so around the early morning hours (2 am to 5 am) when no one is working.